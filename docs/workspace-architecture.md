# Workspace architecture

This repository acts as a "meta" workspace so you can develop multiple Airnub Labs projects inside a single Dev Container (locally or in GitHub Codespaces). Instead of juggling many containers or mismatched Supabase ports, every project points at the same shared runtime.

---

## Why a meta workspace?

* **Single container, many repos.** The Dev Container mounts the parent directory that holds all projects, so every sibling repo appears under `/workspaces`.
* **Shared services.** Redis and a Supabase local stack run once for whichever project you are actively developing.
* **Consistent tooling.** Docker-in-Docker, Node 24 + pnpm, and Python 3.12 are pre-installed via Dev Container Features, matching what each project expects.

Opening the workspace file keeps multiple repos in view while still letting each project maintain its own `.devcontainer/` for standalone work.

---

## Key components

| Path | Purpose |
| ---- | ------- |
| [`airnub-labs.code-workspace`](../airnub-labs.code-workspace) | VS Code multi-root workspace that lists the repos you want to open together. |
| [`.devcontainer/devcontainer.json`](../.devcontainer/devcontainer.json) | Acts as the Codespaces bridge. It reuses the `workspaces/webtop/.devcontainer` configuration so local Dev Containers and Codespaces stay in sync. |
| [`workspaces/<variant>/.devcontainer/`](../workspaces) | Each variant (currently `webtop` and `novnc`) ships a self-contained Dev Container with compose file, features, and sidecars. |
| [`workspaces/<variant>/postCreate.sh`](../workspaces/webtop/postCreate.sh) | Lifecycle hook that applies permissions, prepares pnpm, and clones repos declared in `workspace.blueprint.json` into `/apps`. |
| [`workspaces/<variant>/workspace.blueprint.json`](../workspaces/webtop/workspace.blueprint.json) | Declarative manifest that lists external repos to clone on `postCreate`. |
| [`supabase/`](../supabase) | Holds the shared Supabase config (`config.toml`), helper scripts, and `.env.local` generated by the Supabase CLI. |
| [`devcontainers/`](../devcontainers) | (Planned) Catalogue of spec-compliant features, templates, and stacks used to compose the workspace and publish reusable building blocks. |

### Dev Container highlights

* **Features:** Docker-in-Docker, Node 24 (with pnpm), and Python 3.12 are applied via reusable features defined in `workspaces/<variant>/.devcontainer/devcontainer.json`.
* **Port forwarding:** Supabase services (API `54321`, Postgres `54322`, Studio `54323`, Inbucket `54324`, Storage `54326`, Analytics `54327`), Redis `6379`, and the GUI desktops (`3001` for Webtop, `6080` for noVNC) are exposed for local and Codespaces use.
* **Persistent pnpm store:** Initialised in `postCreate.sh` so pnpm caches live under `/home/vscode/.pnpm-store` across rebuilds.
* **Workspace mounts:** Compose mounts the repository root at `/workspaces`, and cloned app repos land in `/apps` so they stay ignored by Git.

---

## Relationship to per-project containers

Each product repo still ships its own `.devcontainer/` so you can open it directly in VS Code or Codespaces with an isolated environment. Use that when you only need a single repo.

Open this meta workspace when you:

* Need to coordinate changes across multiple repos.
* Want to re-use the same Supabase stack while switching projects.
* Prefer a single Codespace window that surfaces all sibling repos.

Because all repos live side-by-side under `/workspaces`, git operations work exactly as if you cloned them locally—no submodules required.

For details on how the reusable packages map to the Dev Containers specification and GHCR distribution model, see the [Dev Container packaging roadmap](./devcontainer-spec-alignment.md).

### How the shared stack improves local performance

Running a single Supabase + Redis stack provides these practical benefits for local development:

* Lower resource usage: one database instance consumes far less memory/CPU than many parallel stacks.
* Faster context switching: switching active repos doesn't require spinning up a fresh Supabase/Redis instance each time.
* Predictable configuration: fixed ports and a single `supabase/.env.local` remove the need to hunt for per-repo ports or credentials.

If you have a machine with limited resources or frequently work across repos, the meta workspace reduces friction and improves iteration speed.

---

## Clone automation

`postCreate.sh` reads [`workspace.blueprint.json`](../workspaces/webtop/workspace.blueprint.json) and clones any missing repos into `/apps`. The helper is idempotent—rerun it anytime to fetch updates without touching local changes.

For a deeper dive into permissions, auth modes, and configuration knobs, read the [Workspace clone strategy](./clone-strategy.md).

---

## Operational tips

* **One Supabase stack at a time.** Keep the shared stack running via `supabase start -o env`; don’t launch separate stacks per project.
* **Rebuild vs. recreate.** Container configuration changes usually need a **Rebuild**; updates to Codespaces repo permissions require creating a new Codespace session.
* **Keep clones alongside the meta repo.** Let the helper place repos next to this workspace folder (the `.gitignore` ignores everything except the meta tooling). Avoid nesting project clones inside individual repos.
* **Need another window?** VS Code uses one container per window—open an additional window if you need a different container profile.

---

## Common workflow snippets

* **Add another project to the workspace**
  1. Add the folder path to `airnub-labs.code-workspace` so it appears in VS Code.
  2. Append the repo (URL + destination path under `/apps`) to `workspaces/<variant>/workspace.blueprint.json` so `postCreate.sh` knows to clone it.
  3. Re-run `workspaces/<variant>/postCreate.sh` or recreate the Codespace to fetch it.

* **Switch the active project**
  1. Stop any servers from the previous project.
  2. `cd /workspaces/<other-project>` and run that project’s Supabase migrations against the shared stack.

* **Connect a local app to Supabase**
  * Use `SUPABASE_URL=http://localhost:54321` along with the publishable/secret keys from `supabase/.env.local` (or the project’s synced `.env.local`).

## Workspaces layout
- Catalog (publisher): features/, templates/, images/, docs/
- Workspaces: workspaces/<variant> with its own .devcontainer and .code-workspace.
- Apps cloned dynamically into /apps via workspaces/<variant>/workspace.blueprint.json
